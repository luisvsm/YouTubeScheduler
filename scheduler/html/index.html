<!DOCTYPE html>
<html>

<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <style>
        /* Normal white Button as seen on Google.com*/
        button {
            color: #444444;
            background: #F3F3F3;
            border: 1px #DADADA solid;
            padding: 5px 10px;
            border-radius: 2px;
            font-weight: bold;
            font-size: 9pt;
            outline: none;
        }

        button:hover {
            border: 1px #C6C6C6 solid;
            box-shadow: 1px 1px 1px #EAEAEA;
            color: #333333;
            background: #F7F7F7;
        }

        button:active {
            box-shadow: inset 1px 1px 1px #DFDFDF;
        }

        /* Blue button as seen on translate.google.com*/
        button.blue {
            color: white;
            background: #4C8FFB;
            border: 1px #3079ED solid;
            box-shadow: inset 0 1px 0 #80B0FB;
        }

        button.blue:hover {
            border: 1px #2F5BB7 solid;
            box-shadow: 0 1px 1px #EAEAEA, inset 0 1px 0 #5A94F1;
            background: #3F83F1;
        }

        button.blue:active {
            box-shadow: inset 0 2px 5px #2370FE;
        }

        /* Orange button as seen on blogger.com*/
        button.orange {
            color: white;
            border: 1px solid #FB8F3D;
            background: -webkit-linear-gradient(top, #FDA251, #FB8F3D);
            background: -moz-linear-gradient(top, #FDA251, #FB8F3D);
            background: -ms-linear-gradient(top, #FDA251, #FB8F3D);
        }

        button.orange:hover {
            border: 1px solid #EB5200;
            background: -webkit-linear-gradient(top, #FD924C, #F9760B);
            background: -moz-linear-gradient(top, #FD924C, #F9760B);
            background: -ms-linear-gradient(top, #FD924C, #F9760B);
            box-shadow: 0 1px #EFEFEF;
        }

        button.orange:active {
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.3);
        }

        /* Red Google Button as seen on drive.google.com */
        button.red {
            background: -webkit-linear-gradient(top, #DD4B39, #D14836);
            background: -moz-linear-gradient(top, #DD4B39, #D14836);
            background: -ms-linear-gradient(top, #DD4B39, #D14836);
            border: 1px solid #DD4B39;
            color: white;
            text-shadow: 0 1px 0 #C04131;
        }

        button.red:hover {
            background: -webkit-linear-gradient(top, #DD4B39, #C53727);
            background: -moz-linear-gradient(top, #DD4B39, #C53727);
            background: -ms-linear-gradient(top, #DD4B39, #C53727);
            border: 1px solid #AF301F;
        }

        button.red:active {
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.2);
            background: -webkit-linear-gradient(top, #D74736, #AD2719);
            background: -moz-linear-gradient(top, #D74736, #AD2719);
            background: -ms-linear-gradient(top, #D74736, #AD2719);
        }



        /*=======================================*/

        body {
            margin: 50px;
        }

        #queueTable li {
            height: 60px;
            list-style: none;
        }

        #queueTable li button {
            margin: 2px;
            height: 28px;
        }

        #queueTable li input {
            margin: 2px;
            height: 20px;
            padding: 2px;
        }

        #queueTable li img {
            height: 28px;
            vertical-align: middle;
            margin: 0px 0px 0px 20px;
        }

        #queueTable li img:hover {
            cursor: pointer;
        }

        #currentlyPlaying p,
        #currentlyPlaying div {
            display: inline;
        }

        #currentlyPlaying {
            margin: 20px 0px;
        }
    </style>
    <script src="html5sortable.min.js"></script>
</head>

<body>
    <button class="red" onclick="playNextVideo()">Play Next</button>
    <div id="currentlyPlaying">
        <b>Currently Playing</b>
        <br />
        <p>Note: </p>
        <div id="playingNote">N/A</div>
        <br />
        <p>VideoID:</p>
        <div id="playingVideoID">N/A</div>
        <br />
        <p>Time Remaining:</p>
        <div id="playingRemaining">N/A</div>
        <br />
        <p>Minutes per stream</p>
        <input id="minutesPerItem" placeholder="30" size="16" onchange="setMinutesPerItem()">
    </div>
    <button class="button" onclick="addNewRow()">New Item</button>

    <ul id="queueTable"></ul>

    <script>

        var sortabeTable = document.getElementById("queueTable");
        var nowPlayingVideoID = document.getElementById("playingVideoID");
        var nowPlayingNote = document.getElementById("playingNote");
        var nowPlayingRemaining = document.getElementById("playingRemaining");
        var fieldMinutesPerItem = document.getElementById("minutesPerItem");

        var listItems = [];
        var playerWindow;

        var minutesPerItem = 30;
        fieldMinutesPerItem.value = minutesPerItem;

        /*
        function openVideoWindow() {
            playerWindow = window.open("youtubeEmbedTest.html", "_blank");
            playerWindow.focus();
        }
        openVideoWindow();
        */

        function playNextVideo() {
            if (listItems.length == 0 || listItems[0].videoID.value == "") {
                updateTimes();
                return;
            }

            playVideo(listItems[0].videoID.value);
            nowPlayingNote.innerText = listItems[0].note.value;
            nowPlayingVideoID.innerText = listItems[0].videoID.value;
            listItems[0].removeVideo();

        }

        function playVideo(videoID) {
            playerWindow.playVideo(videoID);
        }

        function addNewRow() {
            sortabeTable.appendChild(makeItemRow());
            setSortable();
        }

        function setSortable() {
            sortable('#queueTable', {
                forcePlaceholderSize: true,
                hoverClass: 'highlight'
            })[0].addEventListener('sortupdate', function (e) {
                listItems = [];
                for (let i = 0; i < e.detail.destination.items.length; i++) {
                    listItems.push(e.detail.destination.items[i]);
                    e.detail.destination.items[i].setPosition(i);
                }
            });
            updateTimes();
        }


        function setMinutesPerItem() {
            if (isNaN(fieldMinutesPerItem.value) || fieldMinutesPerItem.value == 0) {
                fieldMinutesPerItem.value = minutesPerItem;
            } else {
                minutesPerItem = fieldMinutesPerItem.value;
                lastPlayTime = undefined;
                updateTimes();
                checkTime();
            }
        }

        // queuePosition
        // 0 - up next
        // 1 - etc
        // 2 - etc
        function getNextPlayTimeInMiliseconds(queuePosition) {
            return (Math.ceil(Date.now() / (minutesPerItem * 60 * 1000)) * minutesPerItem * 60 * 1000) + (minutesPerItem * 60 * 1000 * queuePosition);
        }

        // Thank you Internet friend for a few minutes saved :)
        // https://gist.github.com/vankasteelj/74ab7793133f4b257ea3
        var pad = function (num, size) { return ('000' + num).slice(size * -1); };
        var time, hours, minutes, seconds, milliseconds;
        function sec2time(timeInSeconds) {
            time = parseFloat(timeInSeconds).toFixed(3);
            hours = Math.floor(time / 60 / 60);
            minutes = Math.floor(time / 60) % 60;
            seconds = Math.floor(time - minutes * 60);

            return pad(hours, 2) + ':' + pad(minutes, 2) + ':' + pad(seconds, 2);
        }

        function getLocalPlayTime(playPosition) {
            return new Date(getNextPlayTimeInMiliseconds(playPosition));
        }

        setInterval(checkTime, 1000);
        var nextPlayTime;
        var lastPlayTime;
        var dateRemainingCache;
        var newTotalMinute;

        function checkTime() {

            nextPlayTime = getNextPlayTimeInMiliseconds(0);

            nowPlayingRemaining.innerText = sec2time((nextPlayTime - (Date.now())) / 1000);

            // console.log("nextPlayTime vs lastPlayTime");
            // console.log(nextPlayTime + " vs " + lastPlayTime);

            if (lastPlayTime == undefined)
                lastPlayTime = nextPlayTime;

            if (nextPlayTime > lastPlayTime) {
                lastPlayTime = nextPlayTime;
                playNextVideo();
            }
            // Called once per second
        }

        function getQueryVariable(getVar, url) {
            var questionMarkPos = url.indexOf("?");
            // Clean website out
            if (questionMarkPos >= 0) {
                url = url.substring(questionMarkPos)
            }
            // Check if we need to URL parse
            if (url.includes("=")) {
                var urlParams = new URLSearchParams(url);
                return urlParams.get(getVar);
            } else {
                return url;
            }
        }

        function makeItemRow(
            inputItem = {
                Note: "",
                VideoID: "",
                StreamTitle: "",
                StreamDescription: "",
                DonationLink: "",
                WebsiteLink: ""
            }
        ) {
            var startTime;
            var listElement = document.createElement('li');

            listElement.setPosition = function (index) {
                playTime.innerText = getLocalPlayTime(index);
                StartTime = getNextPlayTimeInMiliseconds(index);
            }

            var playTime = document.createElement('div');
            var playButton = document.createElement('button');
            var testButton = document.createElement('button');

            var note = document.createElement('input');
            var videoID = document.createElement('input');
            var streamTitle = document.createElement('input');
            var streamDescription = document.createElement('input');
            var donationLink = document.createElement('input');
            var websiteLink = document.createElement('input');

            var removeButton = document.createElement('img');

            note.placeholder = "Note";
            note.size = 16;
            note.value = inputItem.Note;
            listElement.note = note;

            videoID.placeholder = "Video ID";
            videoID.size = 30;
            videoID.value = inputItem.VideoID;
            videoID.onchange = function () {
                console.log("parsing ", videoID.value)
                videoID.value = getQueryVariable("v", videoID.value);
            }
            listElement.videoID = videoID;

            streamTitle.placeholder = "Stream Title";
            streamTitle.size = 20;
            streamTitle.value = inputItem.StreamTitle;
            listElement.streamTitle = streamTitle;

            streamDescription.placeholder = "Stream Description";
            streamDescription.size = 50;
            streamDescription.value = inputItem.StreamDescription;
            listElement.streamDescription = streamDescription;

            donationLink.placeholder = "Donation Link";
            donationLink.size = 20;
            donationLink.value = inputItem.DonationLink;
            listElement.donationLink = donationLink;

            websiteLink.placeholder = "Website Link";
            websiteLink.size = 20;
            websiteLink.value = inputItem.WebsiteLink;
            listElement.websiteLink = websiteLink;

            testButton.textContent = "Test Video";

            testButton.classList.add("blue");
            testButton.onclick = function () {
                console.log(videoID.value);
                console.log("testing: " + ("https://www.youtube.com/watch?v=" + videoID.value));
                var win = window.open("https://www.youtube.com/watch?v=" + videoID.value, '_blank');
                win.focus();
            };

            listElement.removeVideo = function () {
                listItems.splice(listItems.indexOf(listElement), 1);
                listElement.remove();
                updateTimes();
            };

            removeButton.src = "img/minus.svg";
            removeButton.onclick = listElement.removeVideo;

            listElement.appendChild(playTime);
            listElement.appendChild(testButton);
            listElement.appendChild(note);
            listElement.appendChild(videoID);
            listElement.appendChild(streamTitle);
            listElement.appendChild(streamDescription);
            listElement.appendChild(donationLink);
            listElement.appendChild(websiteLink);
            listElement.appendChild(removeButton);

            listElement.export = function () {
                return {
                    StartTime: StartTime,
                    Note: note.value,
                    VideoID: videoID.value,
                    StreamTitle: streamTitle.value,
                    StreamDescription: streamDescription.value,
                    DonationLink: donationLink.value,
                    WebsiteLink: websiteLink.value
                }
            }

            listItems.push(listElement);
            return listElement;
        }

        function updateTimes() {
            for (let i = 0; i < listItems.length; i++) {
                listItems[i].setPosition(i);
            }
        }

        function exportCSV() {
            var exportObj = exportObject();
            var exportCSV = "";

            exportCSV += '"StartTime",';
            exportCSV += '"Note",';
            exportCSV += '"VideoID",';
            exportCSV += '"StreamTitle",';
            exportCSV += '"StreamDescription",';
            exportCSV += '"DonationLink",';
            exportCSV += '"WebsiteLink"';
            exportCSV += "\n";

            for (let i = 0; i < exportObj.length; i++) {
                exportCSV += '"' + exportObj[i].StartTime + '",';
                exportCSV += '"' + exportObj[i].Note.replace(/"/g, '""') + '",';
                exportCSV += '"' + exportObj[i].VideoID.replace(/"/g, '""') + '",';
                exportCSV += '"' + exportObj[i].StreamTitle.replace(/"/g, '""') + '",';
                exportCSV += '"' + exportObj[i].StreamDescription.replace(/"/g, '""') + '",';
                exportCSV += '"' + exportObj[i].DonationLink.replace(/"/g, '""') + '",';
                exportCSV += '"' + exportObj[i].WebsiteLink.replace(/"/g, '""') + '"';
                exportCSV += "\n";
            }

            return exportCSV;
        }

        function importCSV(allText) {

            var allTextLines = allText.split(/\r\n|\n/);
            var headers = allTextLines[0].split(',');

            var lines = [];
            for (let i = 0; i < headers.length; i++) {
                headers[i] = headers[i].replace(/(^"|"$)/g, "").replace(/""/g, '"').trim();
            }


            for (var i = 1; i < allTextLines.length; i++) {
                var data = allTextLines[i].trim().split(',');
                if (data.length == headers.length) {

                    var importItem = {};
                    for (var j = 0; j < headers.length; j++) {
                        importItem[headers[j]] = data[j].replace(/(^"|"$)/g, "").replace(/""/g, '"');
                    }
                    lines.push(importItem);
                }
            }

            for (var i = 1; i < lines.length; i++) {
                lines[i].StartTime = parseInt(lines[i].StartTime, 10);
            }

            importObject(lines);
        }

        function exportJSON() {
            return JSON.stringify(exportObject());
        }

        function exportObject() {
            var exportObj = [];

            for (let i = 0; i < listItems.length; i++) {
                exportObj.push(listItems[i].export());
            }

            exportObj.sort(function (a, b) { return a.StartTime - b.StartTime });
            return exportObj;
        }

        function importJSON(importObj) {
            return importObject(JSON.parse(importObj));
        }
        function importObject(importObj) {
            if (importObj == undefined || importObj.length < 1) {
                return;
            }

            var importTime = Date.now();
            importObj.sort(function (a, b) { return a.StartTime - b.StartTime });

            // Remove existing elements
            for (let i = 0; i < listItems.length; i++) {
                sortabeTable.removeChild(listItems[i]);
            }
            listItems = [];

            // Add imported elements
            for (let i = 0; i < importObj.length; i++) {
                if (importObj[i].StartTime > importTime) {
                    sortabeTable.appendChild(makeItemRow(importObj[i]));
                }
            }
            // Update times
            updateTimes();
            // Set up the sortable table
            setSortable();
        }

        addNewRow();
        addNewRow();
        addNewRow();

        var secret;
        var requestURL;

        function saveToScheduler() {
            scheduleString = exportJSON();

            const request = new Request(requestURL, {
                method: 'POST',
                body: JSON.stringify({
                    secret: secret,
                    schedule: scheduleString
                })
            });
            fetch(request).then(response => {
                console.log(response);
            });
        }
    </script>
</body>

</html>